<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Soso Galaxy Conquest — FINAL VERSION</title>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: black; }
    #hud {
      position: absolute;
      top: 15px;
      left: 15px;
      padding: 15px;
      background: rgba(0,0,30,0.6);
      color: cyan;
      border: 2px solid cyan;
      border-radius: 12px;
      font-family: monospace;
      z-index: 10;
    }
  </style>
</head>

<body>

<div id="hud">
  <b>SO-SO GALAXY CONQUEST</b><br>
  Clique une planète → clique une autre → flotte envoyée !
</div>

<script>
let selected = null;
const socket = io();

const config = {
  type: Phaser.AUTO,
  width: window.innerWidth,
  height: window.innerHeight,
  backgroundColor: '#000015',
  scene: { preload, create, update }
};

let scene;
let planets = [];
let fleets = [];

new Phaser.Game(config);

// ---------------------
function preload() {
  // ▲ Base64 planet
  this.load.image("planet", "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0N...");
  this.load.image("ship", "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQ...");
}

// ---------------------
function create() {
  scene = this;

  socket.on("update", data => {
    planets = data.planets;
    fleets = data.fleets;
    draw();
  });

  this.input.on("pointerdown", p => {
    const clicked = planets.find(pl => Phaser.Math.Distance.Between(pl.x, pl.y, p.x, p.y) < 40);

    if (!selected && clicked) {
      selected = clicked.id;
      return;
    }

    if (selected && clicked) {
      socket.emit("sendFleet", { from: selected, to: clicked.id });
      selected = null;
    }
  });
}

// ---------------------
function update() {}

// ---------------------
function draw() {
  scene.children.removeAll();

  planets.forEach(p => {
    const sprite = scene.add.image(p.x, p.y, "planet").setScale(0.4);

    scene.add.text(p.x - 20, p.y + 35, p.name, { color: "cyan", fontSize: "14px" });

    if (selected === p.id) {
      scene.add.circle(p.x, p.y, 50, 0x00ffff, 0.3);
    }
  });

  fleets.forEach(f => {
    const from = planets.find(p => p.id === f.from);
    const to   = planets.find(p => p.id === f.to);

    if (!from || !to) return;

    const t = f.progress / 100;
    const x = from.x + (to.x - from.x) * t;
    const y = from.y + (to.y - from.y) * t;

    const ship = scene.add.image(x, y, "ship").setScale(0.3);
    ship.rotation = Phaser.Math.Angle.Between(from.x, from.y, to.x, to.y);
  });
}
</script>
</body>
</html>
