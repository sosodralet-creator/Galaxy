<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Soso Galaxy — Prototype Stable</title>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
<style>
  body { margin:0; overflow:hidden; background:#000011; color:#0ff; font-family:monospace; }
  #ui { position:absolute; top:10px; left:10px; background:rgba(0,0,30,0.7); padding:10px; border-radius:8px; z-index:10; }
  button { margin:4px; padding:6px 10px; border-radius:6px; background:#002233; color:#0ff; border:1px solid #0ff; cursor:pointer; }
</style>
</head>
<body>
<div id="ui">
  <div id="playerInfo">Connecté...</div>
  <div>
    <button onclick="build('mine')">Construire Mine</button>
    <button onclick="build('power')">Construire Centrale</button>
    <button onclick="build('shipyard')">Construire Chantier</button>
  </div>
  <div id="planetInfo"></div>
</div>
<script>
const socket = io();
let state = { planets: [], fleets: [], players: {} };
let selectedPlanet = null;

const config = {
  type: Phaser.AUTO,
  width: window.innerWidth,
  height: window.innerHeight,
  backgroundColor: '#000011',
  scene: { preload, create, update }
};
let sceneRef;
const game = new Phaser.Game(config);

function preload(){
  this.load.image('planet', 'https://i.imgur.com/4AiXzf8.png');
  this.load.image('ship', 'https://i.imgur.com/3b8zXjP.png');
}

function create(){
  sceneRef = this;
  this.input.mouse.disableContextMenu();

  this.input.on('pointerdown', pointer => {
    const clicked = state.planets.find(p => Math.hypot(p.x-pointer.x, p.y-pointer.y)<30);
    if(clicked) selectedPlanet = clicked.id;
  });
}

function update(){
  if(!sceneRef) return;
  sceneRef.children.removeAll();

  state.planets.forEach(p => {
    const sprite = sceneRef.add.image(p.x, p.y, 'planet').setScale(0.2);
    if(p.id === selectedPlanet) sceneRef.add.circle(p.x, p.y, 35, 0x00ffff,0.3);
    sceneRef.add.text(p.x-20,p.y+30,p.name+'\nM:'+p.resources.metal+'\nE:'+p.resources.energy,{color:'#0ff',fontSize:'12px'});
  });

  state.fleets.forEach(f => {
    const from = state.planets.find(p=>p.id===f.from);
    const to = state.planets.find(p=>p.id===f.to);
    if(!from||!to) return;
    const x = from.x + (to.x-from.x)*f.progress;
    const y = from.y + (to.y-from.y)*f.progress;
    sceneRef.add.image(x,y,'ship').setScale(0.1).setAngle(Math.atan2(to.y-from.y,to.x-from.x)*180/Math.PI);
  });

  // update planet info panel
  const infoDiv = document.getElementById('planetInfo');
  const sel = state.planets.find(p=>p.id===selectedPlanet);
  if(sel) infoDiv.innerText = `Sélectionné: ${sel.name}\nM: ${sel.resources.metal}, E: ${sel.resources.energy}`;
  else infoDiv.innerText = '';
}

socket.on('state', s => { state = s; const me = Object.values(s.players).find(p=>p.planetId); if(me) document.getElementById('playerInfo').innerText='Planète assignée: '+me.planetId; });

function build(type){
  if(!selectedPlanet) return alert('Sélectionne une planète');
  socket.emit('build',{planetId:selectedPlanet, building:type});
}
</script>
</body>
</html>
